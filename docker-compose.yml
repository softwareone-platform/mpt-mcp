services:
  # Stdio service - for IDE integration (Claude Desktop, Cursor)
  stdio:
    build: .
    container_name: mpt-mcp-stdio
    environment:
      # Required API Configuration
      MARKETPLACE_API_BASE_URL: ${MARKETPLACE_API_BASE_URL:-https://api.platform.softwareone.com}
      MARKETPLACE_API_TOKEN: ${MARKETPLACE_API_TOKEN}
      OPENAPI_SPEC_URL: ${OPENAPI_SPEC_URL:-https://api.platform.softwareone.com/public/v1/openapi.json}
      
      # Python Configuration
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"
    
    volumes:
      # Mount source code for live development
      - ./src:/app/src
      - ./config:/app/config
      - ./conftest.py:/app/conftest.py
      - ./pytest.ini:/app/pytest.ini
      - ./pyproject.toml:/app/pyproject.toml
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
      # Mount cache for OpenAPI spec
      - ./cache-data:/app/.cache
      
      # Exclude Python cache
      - /app/src/__pycache__
    
    command: python -m src.server_stdio
    
    stdin_open: true
    tty: false
    
    profiles:
      - stdio

  # Development service - hot-reload enabled (HTTP Streamable multi-tenant)
  dev:
    build: .
    container_name: mpt-mcp-dev
    ports:
      - "8080:8080"
    depends_on:
      analytics-db:
        condition: service_healthy
    environment:
      # OpenAPI Spec URL (public, no auth required)
      OPENAPI_SPEC_URL: ${OPENAPI_SPEC_URL:-https://api.platform.softwareone.com/public/v1/openapi.json}
      
      # Server Configuration
      PORT: "8080"
      SSE_DEFAULT_BASE_URL: ${SSE_DEFAULT_BASE_URL:-https://api.platform.softwareone.com}
      
      # GitBook Documentation Integration (Optional)
      GITBOOK_API_KEY: ${GITBOOK_API_KEY:-}
      GITBOOK_SPACE_ID: ${GITBOOK_SPACE_ID:-}
      GITBOOK_API_BASE_URL: ${GITBOOK_API_BASE_URL:-https://api.gitbook.com/v1}
      GITBOOK_CACHE_REFRESH_HOURS: ${GITBOOK_CACHE_REFRESH_HOURS:-24}
      GITBOOK_MAX_CONCURRENT_REQUESTS: ${GITBOOK_MAX_CONCURRENT_REQUESTS:-2}
      GITBOOK_PUBLIC_URL: ${GITBOOK_PUBLIC_URL:-}
      
      # Analytics Database (Optional) - hardcoded for Docker internal network
      # Note: Do NOT use ${ANALYTICS_DATABASE_URL} here as it's set by db-local.sh for host access
      ANALYTICS_DATABASE_URL: postgresql+asyncpg://mcp_user:mcp_password@analytics-db:5432/mcp_analytics
      
      # Development settings
      DEBUG: "true"
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"
      
      # NOTE: No MARKETPLACE_API_TOKEN or MARKETPLACE_API_BASE_URL needed!
      # HTTP server is multi-tenant - clients provide credentials via X-MPT-Authorization header.
      # Middleware captures the request and passes headers to the marketplace API.
    
    volumes:
      # Mount source code for live development
      - ./src:/app/src
      - ./config:/app/config
      - ./tests:/app/tests
      - ./conftest.py:/app/conftest.py
      - ./pytest.ini:/app/pytest.ini
      - ./pyproject.toml:/app/pyproject.toml
      - ./.cache:/app/.cache
      
      # Mount Alembic for live development
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
      
      # Exclude Python cache
      - /app/src/__pycache__
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Production service - no hot-reload, optimized (HTTP Streamable multi-tenant)
  prod:
    build: .
    container_name: mpt-mcp-prod
    ports:
      - "8080:8080"
    environment:
      # OpenAPI Spec URL (public, no auth required)
      OPENAPI_SPEC_URL: ${OPENAPI_SPEC_URL:-https://api.platform.softwareone.com/public/v1/openapi.json}
      
      # Server Configuration
      PORT: "8080"
      SSE_DEFAULT_BASE_URL: ${SSE_DEFAULT_BASE_URL:-https://api.platform.softwareone.com}
      
      # GitBook Documentation Integration (Optional)
      GITBOOK_API_KEY: ${GITBOOK_API_KEY:-}
      GITBOOK_SPACE_ID: ${GITBOOK_SPACE_ID:-}
      GITBOOK_API_BASE_URL: ${GITBOOK_API_BASE_URL:-https://api.gitbook.com/v1}
      GITBOOK_CACHE_REFRESH_HOURS: ${GITBOOK_CACHE_REFRESH_HOURS:-24}
      GITBOOK_MAX_CONCURRENT_REQUESTS: ${GITBOOK_MAX_CONCURRENT_REQUESTS:-2}
      GITBOOK_PUBLIC_URL: ${GITBOOK_PUBLIC_URL:-}
      
      # Production settings
      DEBUG: "false"
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}
      
      # NOTE: No MARKETPLACE_API_TOKEN or MARKETPLACE_API_BASE_URL needed!
      # HTTP server is multi-tenant - clients provide credentials via X-MPT-Authorization header
    
    volumes:
      # Only mount cache for persistence (no source code)
      - cache-prod:/app/.cache
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  
  # Test service - runs Ruff checks and all tests with pytest
  # Note: No profile - this service is built by default with 'docker compose build'
  test:
    build: .
    container_name: mpt-mcp-test
    environment:
      # Test configuration (optional API token for integration tests)
      MARKETPLACE_API_BASE_URL: ${MARKETPLACE_API_BASE_URL:-https://api.platform.softwareone.com}
      MARKETPLACE_API_TOKEN: ${MARKETPLACE_API_TOKEN:-}
      OPENAPI_SPEC_URL: ${OPENAPI_SPEC_URL:-https://api.platform.softwareone.com/public/v1/openapi.json}
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"
    
    volumes:
      # Mount source and tests
      - ./src:/app/src
      - ./tests:/app/tests
      - ./config:/app/config
      - ./conftest.py:/app/conftest.py
      - ./pytest.ini:/app/pytest.ini
      - ./pyproject.toml:/app/pyproject.toml
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
    
    command: sh -c "echo '=== Running Ruff Linter ===' && ruff check src/ tests/ && echo '\n=== Running Ruff Formatter Check ===' && ruff format --check src/ tests/ && echo '\n=== Running Pytest ===' && python -m pytest"
  
  # Ruff service - runs only Ruff linter and formatter (no profile so CI can run it)
  ruff:
    build: .
    container_name: mpt-mcp-ruff
    environment:
      PYTHONUNBUFFERED: "1"
    
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./pyproject.toml:/app/pyproject.toml
    
    command: sh -c "echo '=== Ruff lint (check) ===' && ruff check src/ tests/ && echo '=== Ruff format (check) ===' && ruff format --check src/ tests/ && echo '=== All Ruff checks passed ==='"
  
  # Ruff fix service - runs Ruff with auto-fix (no profile so CI/local can run it)
  ruff-fix:
    build: .
    container_name: mpt-mcp-ruff-fix
    environment:
      PYTHONUNBUFFERED: "1"
    
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./pyproject.toml:/app/pyproject.toml
    
    command: sh -c "ruff check --fix src/ tests/ && ruff format src/ tests/ && echo '\nâœ… Ruff fixes applied!'"
  
  # Test with coverage
  # Note: No profile - this service is built by default with 'docker compose build'
  test-cov:
    build: .
    container_name: mpt-mcp-test-cov
    environment:
      MARKETPLACE_API_BASE_URL: ${MARKETPLACE_API_BASE_URL:-https://api.platform.softwareone.com}
      MARKETPLACE_API_TOKEN: ${MARKETPLACE_API_TOKEN:-}
      OPENAPI_SPEC_URL: ${OPENAPI_SPEC_URL:-https://api.platform.softwareone.com/public/v1/openapi.json}
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/app"
    
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./config:/app/config
      - ./conftest.py:/app/conftest.py
      - ./pytest.ini:/app/pytest.ini
      - ./pyproject.toml:/app/pyproject.toml
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
    
    command: sh -c "echo '=== Running Ruff Linter ===' && ruff check src/ tests/ && echo '\n=== Running Ruff Formatter Check ===' && ruff format --check src/ tests/ && echo '\n=== Running Pytest with Coverage ===' && python -m pytest --cov=src --cov-report=term-missing --cov-report=html"

  # PostgreSQL service for analytics (local development)
  analytics-db:
    image: postgres:16-alpine
    container_name: mpt-mcp-analytics-db
    environment:
      POSTGRES_DB: mcp_analytics
      POSTGRES_USER: mcp_user
      POSTGRES_PASSWORD: mcp_password
    ports:
      - "5432:5432"
    volumes:
      - analytics-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcp_user -d mcp_analytics"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Alembic migration service
  migrate:
    build: .
    container_name: mpt-mcp-migrate
    environment:
      ANALYTICS_DATABASE_URL: postgresql://mcp_user:mcp_password@analytics-db:5432/mcp_analytics
      PYTHONUNBUFFERED: "1"
    volumes:
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
      - ./src:/app/src
    command: alembic upgrade head
    depends_on:
      analytics-db:
        condition: service_healthy
    profiles:
      - analytics

volumes:
  cache-prod:
  analytics-data:

