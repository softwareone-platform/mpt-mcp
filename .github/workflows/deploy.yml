name: Deploy to Google Cloud Run

on:
  push:
    tags:
      - 'release/*'
      - 'test/*'
  workflow_dispatch:

jobs:
  lint:
    name: Lint with Ruff
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      run: docker compose build ruff

    - name: Run Ruff linter
      run: docker compose run --rm ruff

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      run: docker compose build test

    - name: Run Ruff linter (fail fast)
      run: docker compose run --rm ruff

    - name: Run tests
      run: docker compose run --rm test

  deploy:
    needs: [lint, test]
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker

    - name: Build and push Docker image
      run: |
        docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:${{ github.sha }} .
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:${{ github.sha }}
        docker tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:latest
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:latest

    - name: Deploy to Cloud Run
      run: |
        ENV_VARS="HTTP_HOST=0.0.0.0,HTTP_DEFAULT_BASE_URL=https://api.platform.softwareone.com"
        if [ -n "${{ secrets.ANALYTICS_DATABASE_URL }}" ]; then
          ENV_VARS="$ENV_VARS,ANALYTICS_DATABASE_URL=${{ secrets.ANALYTICS_DATABASE_URL }}"
          # Extract Cloud SQL connection name from ANALYTICS_DATABASE_URL if present
          # Format: postgresql+asyncpg://...?host=/cloudsql/PROJECT:REGION:INSTANCE
          CLOUD_SQL_CONN=$(echo "${{ secrets.ANALYTICS_DATABASE_URL }}" | grep -oP '/cloudsql/\K[^?]+' || echo "")
        fi
        if [ -n "${{ secrets.GITBOOK_API_KEY }}" ] && [ -n "${{ secrets.GITBOOK_SPACE_ID }}" ]; then
          ENV_VARS="$ENV_VARS,GITBOOK_API_KEY=${{ secrets.GITBOOK_API_KEY }},GITBOOK_SPACE_ID=${{ secrets.GITBOOK_SPACE_ID }}"
          if [ -n "${{ secrets.GITBOOK_PUBLIC_URL }}" ]; then
            ENV_VARS="$ENV_VARS,GITBOOK_PUBLIC_URL=${{ secrets.GITBOOK_PUBLIC_URL }}"
          fi
        fi
        DEPLOY_CMD="gcloud run deploy mpt-mcp \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:${{ github.sha }} \
          --platform managed \
          --region ${{ secrets.GCP_REGION }} \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 1 \
          --timeout 300 \
          --concurrency 80 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars \"$ENV_VARS\""
        if [ -n "$CLOUD_SQL_CONN" ]; then
          DEPLOY_CMD="$DEPLOY_CMD --add-cloudsql-instances=$CLOUD_SQL_CONN"
        fi
        eval $DEPLOY_CMD

    - name: Get Service URL
      id: service-url
      run: |
        SERVICE_URL=$(gcloud run services describe mpt-mcp --platform managed --region ${{ secrets.GCP_REGION }} --format 'value(status.url)')
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "âœ… Deployed to: $SERVICE_URL"

    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Direct URL:** ${{ steps.service-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Custom Domain:** https://mcp.platform.softwareone.com" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-mcp:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Region:** ${{ secrets.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### MCP Endpoint (Use Custom Domain)" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "https://mcp.platform.softwareone.com/mcp" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Health Check" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "curl https://mcp.platform.softwareone.com/health" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
