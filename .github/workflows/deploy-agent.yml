# Deploy Agent Backend to Google Cloud Run
# Runs only when agent/ changes (paths filter). Uses same GCP project/region as MCP.
# Required secrets: GCP_* (same as MCP), CONTEXT_DATABASE_URL, MCP_SERVER_URL,
#   AUTH0_DOMAIN, AUTH0_AUDIENCE, AUTH0_ISSUER, AZURE_OPENAI_API_KEY, AZURE_OPENAI_ENDPOINT,
#   AZURE_OPENAI_DEPLOYMENT_NAME, AGENT_CORS_ORIGINS (e.g. https://agent.platform.softwareone.com)

name: Deploy Agent to Cloud Run

on:
  push:
    branches: [main, master]
    paths: ['agent/**']
  workflow_dispatch:

jobs:
  deploy-agent:
    name: Deploy Agent Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push Agent image
        run: |
          docker build -f agent/backend/Dockerfile.prod -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:${{ github.sha }} agent/backend
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:${{ github.sha }}
          docker tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:latest
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:latest

      - name: Deploy Agent to Cloud Run
        run: |
          MCP_URL="${{ secrets.MCP_SERVER_URL }}"
          [ -z "$MCP_URL" ] && MCP_URL="https://mcp.platform.softwareone.com/mcp"
          ENV_VARS="MCP_SERVER_URL=$MCP_URL,CORS_ORIGINS=${{ secrets.AGENT_CORS_ORIGINS }}"
          ENV_VARS="$ENV_VARS,AUTH0_DOMAIN=${{ secrets.AUTH0_DOMAIN }},AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }},AUTH0_ISSUER=${{ secrets.AUTH0_ISSUER }}"
          ENV_VARS="$ENV_VARS,AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }},AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }},AZURE_OPENAI_DEPLOYMENT_NAME=${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}"
          ENV_VARS="$ENV_VARS,CONTEXT_DATABASE_URL=${{ secrets.CONTEXT_DATABASE_URL }}"
          if [ -n "${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME_OUTPUT }}" ]; then
            ENV_VARS="$ENV_VARS,AZURE_OPENAI_DEPLOYMENT_NAME_OUTPUT=${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME_OUTPUT }}"
          fi
          if [ -n "${{ secrets.REQUIRE_OPERATIONS_ACCOUNT }}" ]; then
            ENV_VARS="$ENV_VARS,REQUIRE_OPERATIONS_ACCOUNT=${{ secrets.REQUIRE_OPERATIONS_ACCOUNT }}"
          fi
          CLOUD_SQL_CONN=$(echo "${{ secrets.CONTEXT_DATABASE_URL }}" | grep -oP '/cloudsql/\K[^?]+' || echo "")
          DEPLOY_CMD="gcloud run deploy mpt-agent \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:${{ github.sha }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --set-env-vars \"$ENV_VARS\""
          if [ -n "$CLOUD_SQL_CONN" ]; then
            DEPLOY_CMD="$DEPLOY_CMD --add-cloudsql-instances=$CLOUD_SQL_CONN"
          fi
          eval $DEPLOY_CMD

      - name: Get Service URL
        id: service-url
        run: |
          SERVICE_URL=$(gcloud run services describe mpt-agent --platform managed --region ${{ secrets.GCP_REGION }} --format 'value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Agent deployed to: $SERVICE_URL"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Agent Backend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.service-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** gcr.io/${{ secrets.GCP_PROJECT_ID }}/mpt-agent:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
